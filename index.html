<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>临时链接生成工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        dark: '#1E293B',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
            .drag-over {
                @apply border-primary bg-primary/5;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 密码验证界面 -->
        <div id="passwordScreen" class="py-12">
            <div class="bg-white rounded-xl p-8 card-shadow">
                <div class="text-center mb-6">
                    <i class="fa fa-link text-5xl text-primary mb-4"></i>
                    <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark">临时链接生成工具</h1>
                    <p class="text-gray-500 mt-2">请输入访问密码</p>
                </div>
                
                <div class="max-w-md mx-auto">
                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <div class="relative">
                            <input type="password" id="password" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all"
                                placeholder="请输入密码">
                            <button id="togglePassword" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fa fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button id="submitPassword" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                        <i class="fa fa-unlock-alt"></i>
                        <span>验证密码</span>
                    </button>
                    
                    <p id="passwordError" class="text-danger text-sm mt-3 text-center hidden">密码错误，请重试</p>
                </div>
            </div>
        </div>

        <!-- 主工具界面 -->
        <div id="mainTool" class="hidden">
            <header class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark">临时链接生成工具</h1>
                        <p class="text-gray-500">创建有时效和访问限制的自定义链接</p>
                    </div>
                    <button id="logoutBtn" class="text-gray-500 hover:text-danger transition-colors flex items-center gap-1">
                        <i class="fa fa-sign-out"></i>
                        <span>退出</span>
                    </button>
                </div>
            </header>

            <!-- 链接生成表单 -->
            <div class="bg-white rounded-xl p-6 md:p-8 card-shadow mb-8">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <i class="fa fa-plus-circle text-primary"></i>
                    生成新链接
                </h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="contentType" class="block text-sm font-medium text-gray-700 mb-1">内容类型</label>
                        <select id="contentType" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all">
                            <option value="url">网址</option>
                            <option value="image">图片</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="contentValueContainer" class="block text-sm font-medium text-gray-700 mb-1">
                            内容值
                            <span id="contentPlaceholder" class="text-gray-400 text-xs">(例如: https://example.com)</span>
                        </label>
                        
                        <!-- 内容输入容器 -->
                        <div id="contentValueContainer">
                            <input type="text" id="contentValue" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all"
                                placeholder="输入网址或图片URL">
                            
                            <!-- 图片拖放区域 -->
                            <div id="imageDropArea" class="mt-3 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hidden">
                                <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500 mb-1">将图片拖到此处，或</p>
                                <label class="text-primary hover:text-primary/80 cursor-pointer font-medium">
                                    <span>浏览文件</span>
                                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                                </label>
                                <p id="dropImageName" class="mt-2 text-sm text-gray-600 hidden"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="expiryTime" class="block text-sm font-medium text-gray-700 mb-1">有效时间 (分钟)</label>
                        <input type="number" id="expiryTime" value="5" min="1" max="60"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all">
                    </div>
                    
                    <div>
                        <label for="maxViews" class="block text-sm font-medium text-gray-700 mb-1">最大访问次数</label>
                        <input type="number" id="maxViews" value="3" min="1" max="10"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all">
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="generateBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg transition-all flex items-center gap-2">
                        <i class="fa fa-magic"></i>
                        <span>生成链接</span>
                    </button>
                </div>
            </div>
            
            <!-- 生成的链接列表 -->
            <div class="bg-white rounded-xl p-6 md:p-8 card-shadow">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <i class="fa fa-list-alt text-primary"></i>
                    已生成的链接
                </h2>
                
                <div id="linksList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8 border border-dashed border-gray-200 rounded-lg">
                        <i class="fa fa-link text-3xl mb-2 opacity-30"></i>
                        <p>暂无生成的链接</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 链接查看页面 -->
        <div id="linkView" class="hidden py-12">
            <div id="activeContent" class="bg-white rounded-xl p-6 md:p-8 card-shadow hidden">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-medium text-gray-700">链接内容</h2>
                    <div class="text-xs text-gray-500 flex items-center gap-1">
                        <i class="fa fa-eye"></i>
                        <span id="viewCount">已查看: 1/3 次</span>
                    </div>
                </div>
                
                <div id="urlContent" class="hidden">
                    <iframe id="contentFrame" class="w-full h-[500px] border border-gray-200 rounded-lg" sandbox="allow-same-origin allow-scripts"></iframe>
                </div>
                
                <div id="imageContent" class="hidden flex justify-center items-center">
                    <img id="contentImage" class="max-w-full max-h-[500px] rounded-lg shadow-md" alt="链接内容图片">
                </div>
            </div>
            
            <div id="expiredContent" class="bg-white rounded-xl p-8 card-shadow text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                    <i class="fa fa-link text-2xl text-gray-400"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">链接已失效</h2>
                <p class="text-gray-500 mb-6">感谢您的游戏建议，链接已失效</p>
                <a href="./" class="inline-flex items-center gap-1 text-primary hover:underline">
                    <i class="fa fa-home"></i>
                    <span>返回首页</span>
                </a>
            </div>
        </div>
    </div>

    <!-- 生成成功提示 -->
    <div id="successToast" class="fixed bottom-6 right-6 bg-secondary text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2">
        <i class="fa fa-check-circle"></i>
        <span>链接生成成功！</span>
    </div>

    <script>
        // 全局变量
        const PASSWORD = '007';
        let currentLinks = [];
        let droppedImageDataUrl = null;
        
        // DOM元素
        const passwordScreen = document.getElementById('passwordScreen');
        const mainTool = document.getElementById('mainTool');
        const linkView = document.getElementById('linkView');
        const passwordInput = document.getElementById('password');
        const togglePassword = document.getElementById('togglePassword');
        const submitPassword = document.getElementById('submitPassword');
        const passwordError = document.getElementById('passwordError');
        const logoutBtn = document.getElementById('logoutBtn');
        const contentType = document.getElementById('contentType');
        const contentValue = document.getElementById('contentValue');
        const contentPlaceholder = document.getElementById('contentPlaceholder');
        const expiryTime = document.getElementById('expiryTime');
        const maxViews = document.getElementById('maxViews');
        const generateBtn = document.getElementById('generateBtn');
        const linksList = document.getElementById('linksList');
        const successToast = document.getElementById('successToast');
        const activeContent = document.getElementById('activeContent');
        const expiredContent = document.getElementById('expiredContent');
        const urlContent = document.getElementById('urlContent');
        const imageContent = document.getElementById('imageContent');
        const contentFrame = document.getElementById('contentFrame');
        const contentImage = document.getElementById('contentImage');
        const viewCount = document.getElementById('viewCount');
        const imageDropArea = document.getElementById('imageDropArea');
        const imageUpload = document.getElementById('imageUpload');
        const dropImageName = document.getElementById('dropImageName');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 检查是否已登录
            if (localStorage.getItem('authenticated') === 'true') {
                showMainTool();
                loadLinks();
            }
            
            // 检查是否访问特定链接
            const urlParams = new URLSearchParams(window.location.search);
            const linkId = urlParams.get('id');
            if (linkId) {
                showLinkContent(linkId);
                return;
            }
            
            // 事件监听
            setupEventListeners();
        });
        
        // 设置事件监听
        function setupEventListeners() {
            // 密码相关
            togglePassword.addEventListener('click', togglePasswordVisibility);
            submitPassword.addEventListener('click', verifyPassword);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') verifyPassword();
            });
            
            // 登出
            logoutBtn.addEventListener('click', logout);
            
            // 内容类型切换
            contentType.addEventListener('change', updateContentPlaceholder);
            
            // 生成链接
            generateBtn.addEventListener('click', generateLink);
            
            // 图片上传相关事件
            setupImageUploadEvents();
        }
        
        // 设置图片上传事件监听
        function setupImageUploadEvents() {
            // 拖放事件
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                imageDropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                imageDropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                imageDropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                imageDropArea.classList.add('drag-over');
            }
            
            function unhighlight() {
                imageDropArea.classList.remove('drag-over');
            }
            
            // 处理文件拖放
            imageDropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    handleImageFiles(files);
                }
            }
            
            // 处理文件选择
            imageUpload.addEventListener('change', function() {
                if (this.files.length) {
                    handleImageFiles(this.files);
                }
            });
            
            // 点击上传区域触发文件选择
            imageDropArea.addEventListener('click', function(e) {
                if (!e.target.closest('label')) {
                    imageUpload.click();
                }
            });
        }
        
        // 处理图片文件
        function handleImageFiles(files) {
            const file = files[0];
            
            // 检查是否为图片文件
            if (!file.type.match('image.*')) {
                alert('请选择图片文件');
                return;
            }
            
            // 显示文件名
            dropImageName.textContent = `已选择: ${file.name}`;
            dropImageName.classList.remove('hidden');
            
            // 读取图片并转换为dataURL
            const reader = new FileReader();
            reader.onload = function(e) {
                droppedImageDataUrl = e.target.result;
                contentValue.value = ''; // 清空URL输入
            };
            reader.readAsDataURL(file);
        }
        
        // 切换密码可见性
        function togglePasswordVisibility() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            // 切换图标
            const icon = togglePassword.querySelector('i');
            if (type === 'password') {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // 验证密码
        function verifyPassword() {
            if (passwordInput.value === PASSWORD) {
                localStorage.setItem('authenticated', 'true');
                showMainTool();
                loadLinks();
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-danger');
                setTimeout(() => {
                    passwordInput.classList.remove('border-danger');
                }, 2000);
            }
        }
        
        // 登出
        function logout() {
            localStorage.removeItem('authenticated');
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            showPasswordScreen();
        }
        
        // 更新内容占位符和显示区域
        function updateContentPlaceholder() {
            if (contentType.value === 'url') {
                contentPlaceholder.textContent = '(例如: https://example.com)';
                contentValue.placeholder = '输入网址';
                imageDropArea.classList.add('hidden');
                // 重置图片拖放状态
                droppedImageDataUrl = null;
                dropImageName.classList.add('hidden');
                dropImageName.textContent = '';
            } else {
                contentPlaceholder.textContent = '(例如: https://example.com/image.jpg 或拖入图片)';
                contentValue.placeholder = '输入图片URL或拖放图片';
                imageDropArea.classList.remove('hidden');
            }
        }
        
        // 生成链接
        function generateLink() {
            let contentValueData = '';
            
            // 根据内容类型获取值
            if (contentType.value === 'url') {
                contentValueData = contentValue.value.trim();
                if (!contentValueData) {
                    alert('请输入网址');
                    return;
                }
                
                // 简单验证URL格式
                try {
                    new URL(contentValueData);
                } catch (e) {
                    alert('请输入有效的网址');
                    return;
                }
            } else {
                // 图片类型 - 优先使用拖放的图片
                if (droppedImageDataUrl) {
                    contentValueData = droppedImageDataUrl;
                } else {
                    contentValueData = contentValue.value.trim();
                    if (!contentValueData) {
                        alert('请输入图片URL或拖入图片');
                        return;
                    }
                    
                    // 简单验证URL格式
                    try {
                        new URL(contentValueData);
                    } catch (e) {
                        alert('请输入有效的图片URL');
                        return;
                    }
                }
            }
            
            // 创建链接对象
            const link = {
                id: generateRandomId(),
                type: contentType.value,
                value: contentValueData,
                expiryTime: Date.now() + (parseInt(expiryTime.value) * 60 * 1000),
                maxViews: parseInt(maxViews.value),
                currentViews: 0,
                createdAt: new Date().toISOString()
            };
            
            // 保存链接
            currentLinks.push(link);
            saveLinks();
            renderLinksList();
            
            // 清空输入
            contentValue.value = '';
            // 重置图片拖放状态
            if (contentType.value === 'image') {
                droppedImageDataUrl = null;
                dropImageName.classList.add('hidden');
                dropImageName.textContent = '';
            }
            
            // 显示成功提示
            showToast();
        }
        
        // 生成随机ID
        function generateRandomId(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // 保存链接到本地存储
        function saveLinks() {
            localStorage.setItem('generatedLinks', JSON.stringify(currentLinks));
        }
        
        // 从本地存储加载链接
        function loadLinks() {
            const saved = localStorage.getItem('generatedLinks');
            currentLinks = saved ? JSON.parse(saved) : [];
            renderLinksList();
        }
        
        // 渲染链接列表
        function renderLinksList() {
            if (currentLinks.length === 0) {
                linksList.innerHTML = `
                    <div class="text-center text-gray-500 py-8 border border-dashed border-gray-200 rounded-lg">
                        <i class="fa fa-link text-3xl mb-2 opacity-30"></i>
                        <p>暂无生成的链接</p>
                    </div>
                `;
                return;
            }
            
            // 过滤掉已过期的链接
            currentLinks = currentLinks.filter(link => isLinkActive(link));
            saveLinks();
            
            if (currentLinks.length === 0) {
                renderLinksList();
                return;
            }
            
            // 按创建时间排序（最新的在前）
            currentLinks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            linksList.innerHTML = currentLinks.map(link => {
                const url = `${window.location.origin}${window.location.pathname}?id=${link.id}`;
                const timeLeft = Math.ceil((link.expiryTime - Date.now()) / (60 * 1000));
                const typeIcon = link.type === 'url' ? 'fa-globe' : 'fa-image';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fa ${typeIcon} text-primary"></i>
                                <span class="font-medium">${link.type === 'url' ? '网址链接' : '图片链接'}</span>
                            </div>
                            <div class="text-xs text-gray-500">
                                剩余: ${timeLeft} 分钟 | ${link.currentViews}/${link.maxViews} 次
                            </div>
                        </div>
                        
                        <div class="mb-3 break-all text-sm text-gray-600">
                            ${link.type === 'image' && link.value.startsWith('data:image/') ? 
                                '拖入的图片' : link.value}
                        </div>
                        
                        <div class="flex flex-wrap gap-2 items-center">
                            <div class="relative flex-grow min-w-[200px]">
                                <input type="text" value="${url}" readonly 
                                    class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded bg-gray-50 focus:ring-1 focus:ring-primary focus:border-primary">
                                <button onclick="copyToClipboard('${url}', this)" 
                                    class="absolute right-1 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary text-xs px-2 py-0.5">
                                    复制
                                </button>
                            </div>
                            
                            <a href="${url}" target="_blank" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded transition-colors">
                                预览
                            </a>
                            
                            <button onclick="deleteLink('${link.id}')" class="text-xs text-gray-500 hover:text-danger px-3 py-1.5 rounded transition-colors">
                                删除
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 显示链接内容
        function showLinkContent(linkId) {
            const link = currentLinks.find(l => l.id === linkId);
            
            // 如果链接不存在，直接显示已过期
            if (!link) {
                showLinkView();
                return;
            }
            
            // 检查链接是否有效
            if (isLinkActive(link)) {
                // 增加访问次数
                link.currentViews++;
                saveLinks();
                
                // 显示内容
                activeContent.classList.remove('hidden');
                expiredContent.classList.add('hidden');
                
                if (link.type === 'url') {
                    urlContent.classList.remove('hidden');
                    imageContent.classList.add('hidden');
                    contentFrame.src = link.value;
                } else {
                    urlContent.classList.add('hidden');
                    imageContent.classList.remove('hidden');
                    contentImage.src = link.value;
                    contentImage.alt = '链接内容图片';
                }
                
                viewCount.textContent = `已查看: ${link.currentViews}/${link.maxViews} 次`;
                
                // 如果达到最大访问次数，标记为过期
                if (link.currentViews >= link.maxViews) {
                    link.expiryTime = Date.now() - 1;
                    saveLinks();
                }
            }
            
            showLinkView();
        }
        
        // 检查链接是否有效
        function isLinkActive(link) {
            return Date.now() < link.expiryTime && link.currentViews < link.maxViews;
        }
        
        // 复制到剪贴板
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '已复制';
                button.classList.add('text-green-600');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('text-green-600');
                }, 2000);
            });
        }
        
        // 删除链接
        function deleteLink(linkId) {
            if (confirm('确定要删除这个链接吗？')) {
                currentLinks = currentLinks.filter(link => link.id !== linkId);
                saveLinks();
                renderLinksList();
            }
        }
        
        // 显示提示
        function showToast() {
            successToast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                successToast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        // 显示密码界面
        function showPasswordScreen() {
            passwordScreen.classList.remove('hidden');
            mainTool.classList.add('hidden');
            linkView.classList.add('hidden');
        }
        
        // 显示主工具界面
        function showMainTool() {
            passwordScreen.classList.add('hidden');
            mainTool.classList.remove('hidden');
            linkView.classList.add('hidden');
        }
        
        // 显示链接查看界面
        function showLinkView() {
            passwordScreen.classList.add('hidden');
            mainTool.classList.add('hidden');
            linkView.classList.remove('hidden');
            
            // 如果没有活动内容，显示已过期
            if (activeContent.classList.contains('hidden')) {
                expiredContent.classList.remove('hidden');
            }
        }
        
        // 暴露函数到全局，以便在HTML中调用
        window.copyToClipboard = copyToClipboard;
        window.deleteLink = deleteLink;
    </script>
</body>
</html>
